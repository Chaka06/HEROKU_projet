{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Support Chat - Administration{% endblock %}

{% block content %}
<h1>Chat Support - {{ user_obj.get_full_name }} (@{{ user_obj.username }})</h1>

<div class="module" style="margin-top: 20px;">
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h2 style="margin: 0 0 10px 0;">Informations Client</h2>
        <p><strong>Nom :</strong> {{ user_obj.get_full_name }}</p>
        <p><strong>Email :</strong> {{ user_obj.email }}</p>
        {% if user_obj.bank_accounts.exists %}
        <p><strong>Banque :</strong> {{ user_obj.bank_accounts.first.bank.name }}</p>
        {% endif %}
    </div>
    
    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; height: 500px; display: flex; flex-direction: column;">
        <div style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;" id="messagesContainer">
            {% for msg in messages_list %}
            <div style="max-width: 70%; {% if msg.sender_is_staff %}align-self: flex-end;{% else %}align-self: flex-start;{% endif %}">
                <div style="padding: 12px 16px; border-radius: 12px; {% if msg.sender_is_staff %}background: linear-gradient(135deg, #117ACA 0%, #0056A3 100%); color: white; border-bottom-right-radius: 4px;{% else %}background: #f0f0f0; color: #1a1a1a; border-bottom-left-radius: 4px;{% endif %}">
                    <div style="font-size: 14px; line-height: 1.5;">{{ msg.message }}</div>
                    <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">
                        {{ msg.created_at|date:"d/m/Y H:i" }}
                    </div>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; color: #999; margin: auto;">
                <p>Aucun message</p>
            </div>
            {% endfor %}
        </div>
        
        <form method="post" style="padding: 16px; border-top: 1px solid #ddd; display: flex; gap: 12px;">
            {% csrf_token %}
            <textarea name="message" placeholder="Écrivez votre réponse..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px;" rows="2" required></textarea>
            <button type="submit" style="width: 50px; height: 50px; background: linear-gradient(135deg, #117ACA 0%, #0056A3 100%); color: white; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 20px;">➤</span>
            </button>
        </form>
    </div>
    
    <div style="margin-top: 20px;">
        <a href="{% url 'admin:banking_supportmessage_changelist' %}" class="button">← Retour à la liste</a>
    </div>
</div>

<script>
    // Scroller en bas au chargement
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
</script>
{% endblock %}
